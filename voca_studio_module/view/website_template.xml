<odoo>
    <data>
        <template id="voca_studio_module.teacher_login_restriction" name="Teacher Login Restriction">
            <t t-call="portal.portal_layout">
                <div class="container mt16">
                    <div class="alert alert-danger">
                        <h3>Access Denied</h3>
                        <p>You are not allowed to log in because your request is pending.</p>
                    </div>
                </div>
            </t>
        </template>


        <template id="new" inherit_id="website_sale.product_quantity" name="Select Quantity">
            <xpath expr="//input[@name='add_qty']" position="inside">
                <script>
                    document.getElementsByClassName('css_quantity')[0].style='display: none !important'
                    document.getElementsByClassName('product_price')[0].style='display: none !important'
                    document.getElementsByClassName('breadcrumb')[0].style='display: none !important'
                    document.getElementById('product_detail_main').previousElementSibling.style='display: none !important'
                    <!--                    document.getElementsByClassName('o_wsale_product_images')[0].class='col-lg-8 mt-lg-4 o_wsale_product_images position-relative'-->
                </script>

            </xpath>


            <xpath expr="//input[@name='add_qty']" position="attributes">
                <attribute name="t-att-value">
                    <t t-if="request.session.get('package_id')">
                        <t t-esc="request.session.get('package_id').get('quantity')"/>
                    </t>
                    <t t-else="">
                        3
                    </t>
                </attribute>
            </xpath>

            <xpath expr="//input[@name='add_qty']" position="attributes">
                <attribute name="id">quantity</attribute>
            </xpath>


        </template>


        <template id="ecom_hide_fields" inherit_id="website_sale.product" active="True" name="Hide Extra Fields">

            <xpath expr="//div[@id='add_to_cart_wrap']" position="replace">
                <div id="add_to_cart_wrap"
                     style="pointer-events: none; opacity: 0.5;"
                     t-attf-class="{{'d-none' if combination_info['prevent_zero_price_sale'] else 'd-inline-flex'}} align-items-center mb-2 me-auto">
                    <a data-animation-selector=".o_wsale_product_images" role="button" id="add_to_cart"
                       t-attf-class="btn btn-primary js_check_product a-submit flex-grow-1" href="#">
                        <i class="fa fa-calendar me-2"/>
                        Book Now
                    </a>
                </div>

            </xpath>
            <xpath expr="//div[@id='add_to_cart_wrap']" position="before">
                <div class="mt-3 mb-3 w-100">
                        <t t-out="product.is_master"/>
                    <h3 t-if="product.is_master">
                        <strong t-field="product.currency_id"/>
                        <span class="text-secondary" t-field="product.list_price"/>
                    </h3>

                    <h3 t-else="">
                        <strong t-field="product.currency_id"/>
                        <span class="text-secondary" t-out="request.session.get('package_id').get('price')"/>
                    </h3>

                </div>
            </xpath>
        </template>
        <template id="carousel_product" inherit_id="website_sale.shop_product_carousel" name="Carousel Product ">
            <!--                    <xpath expr="//div[@class='o_carousel_product_outer carousel-outer position-relative flex-grow-1 overflow-hidden'][1]"-->
            <!--                           position="replace">-->


            <!--                    </xpath>-->
        </template>


        <template id="hide_image" inherit_id="website_sale.product" active="True" name="Hide Image">
            <!--            <xpath expr="//div[hasclass('o_wsale_product_images')]" position="attributes">-->
            <!--                <attribute name="class" remove="col-lg-6" add="col-lg-8" separator=" "/>-->

            <!--            </xpath>-->

            <xpath expr="//div[@id='product_detail_main'][1]/div[1]/t[1]" position="replace">

                <style>
                    /* Style for the list */
                    .available-days-list {
                    list-style-type: none; /* Remove default bullet points */
                    padding: 0;
                    }

                    .available-days-list .day-item {
                    padding: 10px;
                    margin-bottom: 5px;
                    background-color: #f8f9fa; /* Light background for list items */
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    font-size: 1.1rem;
                    cursor: pointer;
                    }

                    .available-days-list .day-item:hover {
                    background-color: #e9ecef; /* Slightly darker on hover */
                    }

                    /* Hide available times initially */
                    .available-times {
                    display: none;
                    margin-top: 10px;
                    background-color: #fff;
                    border: 1px solid #ddd;
                    padding: 10px;
                    border-radius: 5px;
                    }

                    /* Show available times when the div is clicked */
                    .available-times.show {
                    display: block;
                    }

                    /* Style for selected time */
                    .available-times ul li.selected {
                    background-color: #007bff; /* Blue background for selected time */
                    color: white; /* White text for selected time */
                    cursor: pointer;
                    }

                    .available-times ul li:hover {
                    background-color: #e9ecef; /* Slightly darker on hover */
                    cursor: pointer;
                    }

                    /* Disabled day item */
                    .day-item.disabled {
                    pointer-events: none;
                    opacity: 0.6; /* Make disabled days look faded */
                    }

                    /* Disabled time slot */
                    .available-times ul li.disabled {
                    pointer-events: none;
                    opacity: 0.6; /* Make disabled time slots look faded */
                    }
                </style>
                <t t-set="teacher"
                   t-value="request.env['voca.teacher'].sudo().search([('product_id', '=', product.product_variant_id.id)])"/>
                <t t-set="master"
                   t-value="request.env['master.classes'].sudo().search([('product_id', '=', product.id)])"/>
                <input type="hidden" t-att-value="product.id" id="product"></input>
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet"/>
                <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
                <div id="available_days_container" style="display: none;">
                    <h3>Available Days:</h3>
<!--                    <div id="available_days" class="d-flex flex-wrap">-->
<!--                        <t t-foreach="master.dates_ids" t-as="date_record">-->
<!--                            <span class="badge bg-secondary me-1">-->
<!--                                <t t-esc="date_record.date.strftime('%Y-%m-%d')"/>-->
<!--                            </span>-->
<!--                        </t>-->
<!--                    </div>-->
                </div>
                <div id="calendar" style="width:100%"></div>
                <style>
                    .selected-booking {
                    background-color: #4CAF50 !important; /* Green background */
                    color: white !important; /* White text */
                    }
                </style>
                <input type="hidden" id="selected_bookings" name="selected_bookings" value=""/>



                <script>
    document.addEventListener('DOMContentLoaded', function() {
        let teacher_id = document.getElementById('product').value;
        let tt = document.getElementById('product');
        let availableDaysContainer = document.getElementById('available_days_container');
        let availableDaysEl = document.getElementById('available_days');
        let selectedBookings = {}; // To store clicked bookings and associated quantities

        console.info('product master ------', tt);

        $.ajax({
            url: '/check_master_product',
            data: {
                product_id: teacher_id // Replace teacher_id with the actual product ID
            },
            dataType: 'json',
            success: function(response) {

                console.info('response : ', response);
                let calendarEl = document.getElementById('calendar');
                let calendar;
                if (response.is_master) {
                            console.info('product isssss master ------');

                    let quantityInput = document.getElementById('quantity');
                    if (quantityInput) {
                        quantityInput.value = 1; // Set default value for master products
                    }

                    // Initialize the calendar without time slots (for master product)
                    document.getElementById('add_to_cart_wrap').style.pointerEvents = 'none';
                    document.getElementById('add_to_cart_wrap').style.opacity = '0.5';
                    calendarEl.style.display = 'block'; // Ensure calendar is visible for master products
                    availableDaysContainer.style.display = 'block';
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        events: [],
                        eventClick: function(info) {
                            let clickedEvent = info.event;
                            let quantity = parseInt(document.getElementById('quantity').value, 10);

                            if (selectedBookings[clickedEvent.start]) {
                                delete selectedBookings[clickedEvent.start];
                                clickedEvent.setProp('classNames', []);
                            } else {
                                if (Object.keys(selectedBookings).length &lt; quantity) {
                                    selectedBookings[clickedEvent.start] = 1;
                                    clickedEvent.setProp('classNames', ['selected-booking']);
                                } else {
                                    alert(`You can only select ${quantity} bookings.`);
                                }
                            }

                            if (Object.keys(selectedBookings).length === quantity) {
                                document.getElementById('add_to_cart_wrap').style.pointerEvents = 'auto';
                                document.getElementById('add_to_cart_wrap').style.opacity = '1';
                            } else {
                                document.getElementById('add_to_cart_wrap').style.pointerEvents = 'none';
                                document.getElementById('add_to_cart_wrap').style.opacity = '0.5';
                            }

                            $.ajax({
                                url: '/save_booking_to_session',
                                data: {
                                    selected_book: JSON.stringify({ selected_book: selectedBookings }),
                                },
                                dataType: 'json',
                                success: function(response) {
                                    console.log('Bookings saved to session:', response);
                                },
                                error: function(error) {
                                    console.error(`Error saving bookings: ${error}`);
                                }
                            });
                        }
                    });

                    $.ajax({
                        url: `/online-booking/master/`,
                        data: {
                            product_id: teacher_id
                        },
                        dataType: 'json',
                        success: function(result) {
                            // Prepare events array
                            let events = result.map(item => ({
                                title: item.name,
                                start: item.date,
                                allDay: true
                            }));
                            console.info('events111111:', events);

                            // Uncomment this line to add events to the calendar if needed
                             calendar.addEventSource(events);
                            calendar.render();

                        },
                        error: function(error) {
                            console.error(`Error fetching dates: ${error}`);
                        }
                    });

                } else {
                    // Initialize the calendar with time slots (for non-master product)
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        events: [],
                        eventClick: function(info) {
                            let clickedEvent = info.event;
                            let quantity = parseInt(document.getElementById('quantity').value, 10);

                            if (selectedBookings[clickedEvent.start]) {
                                delete selectedBookings[clickedEvent.start];
                                clickedEvent.setProp('classNames', []);
                            } else {
                                if (Object.keys(selectedBookings).length &lt; quantity) {
                                    selectedBookings[clickedEvent.start] = 1;
                                    clickedEvent.setProp('classNames', ['selected-booking']);
                                } else {
                                    alert(`You can only select ${quantity} bookings.`);
                                }
                            }

                            if (Object.keys(selectedBookings).length === quantity) {
                                document.getElementById('add_to_cart_wrap').style.pointerEvents = 'auto';
                                document.getElementById('add_to_cart_wrap').style.opacity = '1';
                            } else {
                                document.getElementById('add_to_cart_wrap').style.pointerEvents = 'none';
                                document.getElementById('add_to_cart_wrap').style.opacity = '0.5';
                            }

                            $.ajax({
                                url: '/save_booking_to_session',
                                data: {
                                    selected_book: JSON.stringify({ selected_book: selectedBookings }),
                                },
                                dataType: 'json',
                                success: function(response) {
                                    console.log('Bookings saved to session:', response);
                                },
                                error: function(error) {
                                    console.error(`Error saving bookings: ${error}`);
                                }
                            });
                        }
                    });

                    // Fetch bookings data using AJAX (for non-master product)
                    $.ajax({
                        url: '/get_booking_by_day',
                        data: {
                            teacher_id: teacher_id
                        },
                        dataType: 'json',
                        success: function(result) {
                            let events = [];
                            Object.keys(result).forEach(function(day) {
                                result[day].forEach(function(time) {
                                    let fullDateTime = new Date(day + ' ' + time);
                                    events.push({
                                        title: 'Available',
                                        start: fullDateTime.toISOString(),
                                        allDay: false,
                                    });
                                });
                            });

                            calendar.addEventSource(events);
                            calendar.render();
                        },
                        error: function(error) {
                            console.error(`Error fetching bookings: ${error}`);
                        }
                    });
                }
            },
            error: function(error) {
                console.error(`Error checking master product: ${error}`);
            }
        });
    });
</script>


            </xpath>

        </template>


    </data>
</odoo>
